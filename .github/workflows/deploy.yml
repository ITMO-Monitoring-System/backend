name: Deploy with Correct Key

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup SSH with PEM key
        run: |
          mkdir -p ~/.ssh
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          
          # –û–ß–ï–ù–¨ –í–ê–ñ–ù–û: –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ —Å–∏–º–≤–æ–ª—ã
          sed -i 's/\\r//g' ~/.ssh/id_rsa
          sed -i 's/\\n/\n/g' ~/.ssh/id_rsa
          sed -i 's/[[:space:]]*$//' ~/.ssh/id_rsa
          
          chmod 600 ~/.ssh/id_rsa
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ ==="
          file ~/.ssh/id_rsa
          head -n 1 ~/.ssh/id_rsa
          echo "=== –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ ==="
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º
          echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º SSH..."
          ssh -v -i ~/.ssh/id_rsa \
              -o ConnectTimeout=5 \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "echo '‚úÖ SSH —É—Å–ø–µ—à–Ω–æ'" || echo "‚ùå –û—à–∏–±–∫–∞ SSH"

      - name: Deploy
        run: |
          ssh -i ~/.ssh/id_rsa \
              -o ConnectTimeout=10 \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "
            set -e
          
            echo '1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é...'
            if [ ! -d '/opt/app' ]; then
              sudo mkdir -p /opt/app
              sudo chown $USER:$USER /opt/app
            fi
          
            cd /opt/app
          
            echo '2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π...'
            if [ ! -d '.git' ]; then
              git clone https://github.com/ITMO-Monitoring-System/backend .
            fi
          
            echo '3. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥...'
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          
            echo '4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker...'
            docker-compose down || true
          
            echo '5. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...'
            docker-compose up -d --build
          
            echo '6. –ü—Ä–æ–≤–µ—Ä—è–µ–º...'
            sleep 3
            docker-compose ps
          
            echo 'üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!'
          "